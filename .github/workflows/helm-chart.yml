name: Helm Chart

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v4.0.5

      - name: Package Helm chart
        run: |
          version="${{ github.event.release.tag_name }}"
          version="${version#v}"

          mkdir -p .chart-repo

          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git fetch origin gh-pages:gh-pages
            git worktree add gh-pages-tmp gh-pages
            cp -R gh-pages-tmp/. .chart-repo/ 2>/dev/null || true
            git worktree remove --force gh-pages-tmp
          fi

          helm package deploy/helm/hytale-server \
            --version "${version}" \
            --app-version "${version}" \
            --destination .chart-repo

          url="https://scotthowson.github.io/hytale-server-pelican"
          if [ -f .chart-repo/index.yaml ]; then
            cp .chart-repo/index.yaml /tmp/index.yaml
            helm repo index .chart-repo --url "${url}" --merge /tmp/index.yaml
          else
            helm repo index .chart-repo --url "${url}"
          fi

      - name: Publish Helm repo to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .chart-repo
          publish_branch: gh-pages
          force_orphan: false
